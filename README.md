# Redirects Matching System

Система для обработки ошибок URL, проверки их статусов и автоматического создания редиректов на основе неточного поиска соответствий в справочниках products и catalog.

## Описание

Проект обрабатывает файлы с ошибками URL, проверяет их доступность через HTTP GET запросы, и создает редиректы на основе неточного поиска соответствий в справочниках товаров и каталогов. Использует алгоритм расстояния Левенштейна для поиска наиболее подходящих соответствий.

## Требования

- Node.js (версия 14 или выше)
- npm

## Установка

1. Клонируйте репозиторий или скачайте проект
2. Установите зависимости:

```bash
npm install
```

## Структура проекта

```
redirects_ex_rules/
├── main.js               # Главное меню (интерактивный интерфейс)
├── index.js              # Основной скрипт обработки
├── exportRedirects.js    # Экспорт редиректов в JSON
├── db.js                 # Модуль работы с БД
├── processErrors.js      # Обработка ошибок
├── loadReferences.js     # Загрузка справочников
├── fuzzyMatch.js         # Неточный поиск
├── package.json
├── README.md
├── .env                  # Переменные окружения (не в git)
├── .env.example          # Шаблон переменных окружения
├── scripts/
│   └── fetch_mongo_data.sh  # Скрипт экспорта данных из MongoDB
└── data/
    ├── nest.pages_error.json    # Файл с ошибками URL
    ├── nest.product1cs.json     # Справочник товаров
    └── nest.catalog1cs.json      # Справочник каталогов
```

## Использование

### Главное меню (рекомендуется)

Для удобной работы используйте главное меню:

```bash
npm run main
```

или

```bash
node main.js
```

Меню предоставляет следующие опции:
1. **Скачать коллекции с сервера** - экспорт данных из MongoDB
2. **Запустить поиск релевантных редиректов** - основная обработка данных
3. **Выгрузить результат в файл "result.json"** - экспорт редиректов
4. **Очистить данные** - удаление всех созданных файлов (БД, JSON файлы)
0. **Выход**

### Получение актуальных данных из MongoDB

Перед запуском основного скрипта рекомендуется обновить данные из MongoDB.

#### Настройка

1. **Создайте файл `.env` в корне проекта** (скопируйте `.env.example`):
   ```bash
   cp .env.example .env
   ```

2. **Отредактируйте `.env` и укажите учетные данные MongoDB:**
   ```env
   MONGO_USERNAME=your_username
   MONGO_PASSWORD=your_password
   MONGO_AUTH_DB=admin
   ```

#### Запуск

После настройки `.env` файла:

```bash
npm run fetch-data
```

или напрямую:

```bash
bash scripts/fetch_mongo_data.sh
```

**Альтернативный способ (без .env файла):**

Можно задать переменные окружения напрямую:

```bash
MONGO_USERNAME=admin MONGO_PASSWORD=your_password bash scripts/fetch_mongo_data.sh
```

#### Описание

Скрипт подключается к серверу `root@90.156.168.41`, экспортирует данные из MongoDB контейнера `mongo_db` (база данных `nest`) и сохраняет в файлы:
- `data/nest.product1cs.json` - коллекция `product1cs` (поле `code`)
- `data/nest.catalog1cs.json` - коллекция `catalog1cs` (поле `code`)

**Требования:**
- Настроенный SSH доступ к серверу (без пароля или с использованием SSH ключей)
- Python 3 для валидации JSON
- Если MongoDB требует аутентификацию, задайте переменные в файле `.env`

**Переменные в .env файле:**
- `MONGO_USERNAME` - имя пользователя MongoDB
- `MONGO_PASSWORD` - пароль пользователя MongoDB
- `MONGO_AUTH_DB` - база данных для аутентификации (по умолчанию `admin`)
- `SSH_HOST` - адрес SSH сервера (по умолчанию `root@90.156.168.41`)
- `MONGO_CONTAINER` - имя контейнера MongoDB (по умолчанию `mongo_db`)
- `MONGO_DB` - имя базы данных (по умолчанию `nest`)
- `DOCKER_COMPOSE_DIR` - путь к директории с docker-compose.yml (по умолчанию `/root/frizar`)

**Примечание:** 
- Скрипт автоматически определяет использование `docker-compose` (если доступен) или `docker exec`
- Файл `.env` добавлен в `.gitignore` и не будет попадать в репозиторий

### Запуск основного скрипта

После получения данных запустите основной скрипт:

```bash
npm start
```

или

```bash
node index.js
```

### Экспорт редиректов в JSON

Для экспорта редиректов в файл `result.json`:

```bash
npm run export
```

или

```bash
node exportRedirects.js
```

Скрипт:
1. Запрашивает минимальный процент соответствия (0-100)
2. Выбирает все редиректы с процентом >= указанного значения
3. Формирует JSON объект вида `{from_url: to_url}`
4. Сохраняет результат в файл `result.json` в корне проекта
5. Выводит статистику по количеству записей и распределению по диапазонам процентов

## Как это работает

### 1. Обработка ошибок

- Читается файл `data/nest.pages_error.json` с массивом объектов `{url: string}`
- Создается/пересоздается таблица `actualStatus` с полями:
  - `url` (TEXT, UNIQUE, INDEX) - URL ошибки
  - `status` (INTEGER) - HTTP статус код (заполняется после проверки)
- Выполняются GET запросы для проверки статуса каждого URL
- **HTTP статус код записывается в поле `status`** для каждой записи
- Обработка выполняется с ограничением параллелизма для предотвращения перегрузки сервера

### 2. Загрузка справочников

- Читаются файлы:
  - `data/nest.product1cs.json` - справочник товаров
  - `data/nest.catalog1cs.json` - справочник каталогов
- Создаются/пересоздаются таблицы `products` и `catalog` с полем:
  - `code` (TEXT, UNIQUE, INDEX) - код записи
- Извлекается поле `code` из каждой записи и загружается в БД

### 3. Создание редиректов

**Важно:** Редиректы создаются **только для страниц с ошибкой** (HTTP статус >= 400).

Для каждой ошибки из `actualStatus` со статусом >= 400:

1. Определяется тип URL (`product` или `catalog`) по пути
2. Извлекается последний сегмент URL (код после последнего `/`)
3. Выполняется неточный поиск в соответствующей таблице (`products` или `catalog`)

**Правила неточного поиска:**

- Игнорируются символы "x" и "kh" (регистронезависимо)
- Используется алгоритм расстояния Левенштейна
- Рассчитывается процент соответствия: `(1 - distance/maxLength) * 100`
- Выбирается запись с максимальным процентом соответствия

4. Создается запись в таблице `redirects`:
   - `from_url` - исходный URL из ошибки
   - `to_url` - `https://frizar.ru/{type}/{найденный_code}`
   - `percent` - процент соответствия

## База данных

Проект использует SQLite. База данных создается автоматически в файле `redirects.db` в корне проекта.

### Таблицы

- **actualStatus** - ошибки URL с их статусами
- **products** - справочник товаров
- **catalog** - справочник каталогов
- **redirects** - созданные редиректы

## Настройки

В файле `index.js` можно настроить:

- `concurrency` - количество одновременных HTTP запросов (по умолчанию 10)

**Примечание:** Проверка статусов URL выполняется всегда. Это необходимо для определения страниц с ошибками, для которых будут создаваться редиректы.

Пример изменения параллелизма:

```javascript
await processErrors(errorsFile, { 
  skipStatusCheck: false, // Всегда проверяем статусы
  concurrency: 20         // Увеличить параллелизм
});
```

## Зависимости

- **better-sqlite3** - работа с SQLite базой данных
- **axios** - HTTP клиент для проверки статусов URL
- **fast-levenshtein** - расчет расстояния Левенштейна для неточного поиска

## Формат входных данных

### nest.pages_error.json

```json
[
  {
    "url": "https://frizar.ru/product/metchik_m12x1_iso2_6h_glukhoy_tin_hss_e_din374_td844536"
  },
  {
    "url": "https://frizar.ru/catalog/rezhushchiy_instrument_dlya_metalloobrabotki/..."
  }
]
```

### nest.product1cs.json / nest.catalog1cs.json

```json
[
  {
    "code": "metchik_m27kh3_iso2_6h_skvoznoy_tin_hss_din371_t8814866_new_century"
  },
  {
    "code": "metchik_m48kh5_iso2_6h_skvoznoy_tin_hss_din371_t8814e26_new_century"
  }
]
```

## Примеры

После выполнения скрипта в таблице `redirects` будут записи вида:

| from_url | to_url | percent |
|----------|--------|---------|
| https://frizar.ru/product/metchik_m12x1_iso2_6h_glukhoy_tin_hss_e_din374_td844536 | https://frizar.ru/product/metchik_m12kh1_iso2_6h_glukhoy_tin_hss_e_din374_td844536 | 98.5 |

## Примечания

- **Проверка статусов обязательна:** Для каждой записи выполняется GET запрос и HTTP статус код записывается в поле `status`
- **Редиректы только для ошибок:** Редиректы создаются только для URL со статусом >= 400 (ошибки сервера)
- При нормализации строк для поиска удаляются символы "x" и "kh", что позволяет находить соответствия между вариантами написания (например, `m12x1` и `m12kh1`)
- Процент соответствия рассчитывается на основе нормализованных строк
- Если соответствие не найдено, запись в `redirects` не создается
- Все операции выполняются в транзакциях для обеспечения целостности данных
- Обработка больших объемов данных может занять значительное время из-за необходимости проверки статусов всех URL

## Лицензия

ISC
